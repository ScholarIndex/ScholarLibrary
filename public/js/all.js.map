{"version":3,"sources":["app.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"all.js","sourcesContent":["\r\n$.expr[\":\"].contains = $.expr.createPseudo(function(arg) {\r\n    return function( elem ) {\r\n        return $(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;\r\n    };\r\n});\r\n\r\nvar LBC = {\r\n\t\r\n\tajx : {abort: function () {}},\r\n\tajx2 : {abort: function() {}},\r\n\tinit : function(){\r\n\t\t\r\n\t\t$.ajaxSetup({\r\n\t\t\terror: function(xhr,status,error){\r\n\t\t\t\tif(xhr.status > 0){\r\n\t\t\t\t\tif(xhr.status == 401){\r\n\t\t\t\t\t\talertify.error(\"You don't have permission to execute this action\");\r\n\t\t\t\t\t}else{\t\r\n\t\t\t\t\t\talertify.error(\"Unknown error\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t});\r\n\t\r\n\t\tvar datajs = $('body').attr('data-js');\r\n\t\tif(datajs !== \"\"){\t\r\n\t\t\twindow[datajs].init();\r\n\t\t}\r\n\r\n\t\t$(document).on('click', '.fa.fa-question-circle', function(){$('#helpwrapper').fadeToggle();});\r\n\r\n\t\tif($('body').attr('data-documentid') !== \"\"){\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/progress/\"+$('body').attr('data-documentid'),\r\n\t\t        type: \"GET\",\r\n\t\t        dataType: \"html\",\r\n\t\t        success: function (data) {\r\n\t\t            $('.progress').html(data);\r\n\t\t        }\r\n\t\t    });\t\t\r\n\t\t    \r\n\t\t    LBC.refreshBookmarks();\t\r\n\t\t}\r\n\t\t\r\n\t\t$(document).on('click', '.bookmarks .fa', function(){\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/ajaxbookmarks/\"+$(this).attr('data-action')+\"/\"+$(this).attr('data-type')+\"/\"+$(this).attr('data-documentid')+\"/\"+$(this).attr('data-pageid'),\r\n\t\t        type: \"GET\",\r\n\t\t        dataType: \"html\",\r\n\t\t        success: function (data) {\r\n\t\t\t\t\talertify.success(\"Bookmark modified successfully\");\r\n\t\t\t\t\tLBC.refreshBookmarks();\r\n\t\t        }\r\n\t\t    });\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.indexgolden .fa', function(){\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/ajaxindexgolden/\"+$(this).attr('data-action')+\"/\"+$(this).attr('data-type')+\"/\"+$(this).attr('data-documentid')+\"/\"+$(this).attr('data-pageid'),\r\n\t\t        type: \"GET\",\r\n\t\t        dataType: \"html\",\r\n\t\t        success: function (data) {\r\n\t\t\t\t\talertify.success(\"Page status modified successfully\");\r\n\t\t\t\t\tLBC.refreshIndexgolden();\r\n\t\t        }\r\n\t\t    });\t\t\t\r\n\t\t});\t\r\n\t},\r\n\r\n\tcheckCred : function(){\r\n\t\tvar roles = $('body').attr('data-cred').split(',');\r\n\t\tif($.inArray('editor', roles) == -1){\r\n\t\t\talertify.error(\"You don't have permission to execute this action\");\r\n\t\t\treturn false;\t\r\n\t\t}else{\r\n\t\t\treturn true;\r\n\t\t}\r\n\t},\r\n\t\r\n\trefreshBookmarks : function(){\r\n\t\tLBC.ajx.abort();\r\n\t\tdocumentId = $('body').attr('data-documentid');\r\n\t\tpageId = $('body').attr('data-pageid');\r\n\t\tLBC.ajx = $.ajax({\r\n\t        url: \"/document/bookmarks/\"+documentId+\"/\"+pageId,\r\n\t        type: \"GET\",\r\n\t        dataType: \"html\",\r\n\t        success: function (data) {\r\n\t            $('.bookmarks').html(data);\r\n\t        }\r\n\t    });\t\t\t\t\r\n\t},\r\n\t\r\n\trefreshIndexgolden : function(){\r\n\t\tLBC.ajx2.abort();\r\n\t\tdocumentId = $('body').attr('data-documentid');\r\n\t\tpageId = $('body').attr('data-pageid');\r\n\t\tLBC.ajx2 = $.ajax({\r\n\t        url: \"/document/indexgolden/\"+documentId+\"/\"+pageId,\r\n\t        type: \"GET\",\r\n\t        dataType: \"html\",\r\n\t        success: function (data) {\r\n\t            $('.indexgolden').html(data);\r\n\t        }\r\n\t    });\t\t\t\t\r\n\t}\t\r\n};\r\n\r\nvar ARTICLEOVERVIEW = {\r\n\tinit : function(){}\r\n};\r\n\r\nvar OVERVIEW = {\r\n\tinit : function(){\r\n\t}\r\n};\r\n\r\nvar SCANS = {\r\n\tinit : function(){\r\n\t}\r\n};\r\n\r\n\r\nvar VIEWER = {\r\n\tinit : function(){\r\n\t\t\r\n\t\tVIEWER.loadPage();\r\n\t\t\r\n\t\t$( window ).hashchange(VIEWER.loadPage);\r\n\t\t\r\n\t\t$(document).keydown(function(e) {\r\n\t\t\tvar n = parseInt(location.hash.replace('#',''),10);\r\n\t\t\tif(isNaN(n)) n = 1;\r\n\r\n\t\t\tmax = parseInt($('.filmstrip .thumb:last').attr('data-n'),10);\r\n\t\t    switch(e.which) {\r\n\t\t        case 37: // left\r\n\t\t\t\tif(n > 1)\r\n\t\t\t\t\tlocation.hash = n-1;\t\r\n\t\t        break;\r\n\t\t\t\t\t\r\n\t\t        case 39: // right\r\n\t\t\t\tif(n < max)\r\n\t\t\t\t\tlocation.hash = n+1;\r\n\t\t        break;\r\n\t\t\r\n\t\t\r\n\t\t        default: return; // exit this handler for other keys\r\n\t\t    }\r\n\t\t    e.preventDefault(); // prevent the default action (scroll / move caret)\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.action.metadata span', function(){\r\n\t\t\t$(this).closest('.action').toggleClass('open');\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.action.split span', function(){\r\n\t\t\tif($('div.splitter').length > 0){\r\n\t\t\t\t$('div.splitter').addClass('enabled');\t\t\t\r\n\t\t\t}else{\r\n\t\t\t\t$('#textview p:first').before(\"<div class='splitter enabled'><span class='splitHere'>validate</span><span class='splitRemove'>&times;</span></div>\");\r\n\t\t\t}\r\n\t\t\t$('#textview').sortable({\r\n\t\t\t\taxis: \"y\",\r\n\t\t\t\thandle: $(\"div.splitter\") \r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t\t\r\n\t\t\r\n        $(document).on('click', '.splitRemove', function(){\r\n\t\t\t$('.splitter').remove();\r\n\t\t\t$.ajax({\r\n\t\t\t\t\turl: \"/document/saveSplit\",\r\n\t\t\t\t\ttype:'POST',\r\n\t\t\t\t\tdataType:'JSON',\r\n\t\t\t\t\tdata:{\r\n\t\t\t\t\t\"page\": $('a.pn.b').attr('data-pageobj'),\r\n\t\t\t\t\t\"split_after_line\" : \"remove\"\r\n\t\t\t\t},\r\n\t\t\t\tsuccess:function(data){\r\n\t\t\t\t\tif(data.result == \"success\"){\r\n\t\t\t\t\t\talertify.success(\"Split removed successfully.\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\t\t\r\n\t\t\r\n        $(document).on('click', '.splitHere', function(){\r\n\t\t\tvar line = $('.splitter').prev('p').attr('l');\r\n\t\t\t$.ajax({\r\n\t\t\t\t\turl: \"/document/saveSplit\",\r\n\t\t\t\t\ttype:'POST',\r\n\t\t\t\t\tdataType:'JSON',\r\n\t\t\t\t\tdata:{\r\n\t\t\t\t\t\"page\": $('a.pn.b').attr('data-pageobj'),\r\n\t\t\t\t\t\"split_after_line\" : line,\r\n\t\t\t\t},\r\n\t\t\t\tsuccess:function(data){\r\n\t\t\t\t\tif(data.result == \"success\"){\r\n\t\t\t\t\t\t$('div.splitter').removeClass(\"enabled\");\r\n\t\t\t\t\t\talertify.success(\"Split line saved successfully.\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\t \t\t\r\n        $(document).on('click', '.action.metadata .save', function(){\r\n        \t\r\n        \t\r\n        \t\r\n        \tvar saisie = new RegExp('^([0-9]+)?(,[0-9]+)?$');\r\n\r\n\t        if ( ! saisie.test($('#ppn').val())) {\r\n\t        \talertify.error(\"Erreur saisie\");\t\r\n\t        \treturn;\r\n\t        }\r\n\t        \t\r\n\t\t\t$.ajax({\r\n\t\t\t\t\turl: \"/document/savePpn\",\r\n\t\t\t\t\ttype:'POST',\r\n\t\t\t\t\tdataType:'JSON',\r\n\t\t\t\t\tdata:{\r\n\t\t\t\t\t\"page\": $('a.pn.b').attr('data-pageobj'),\r\n\t\t\t\t\t\"ppn\" : $('#ppn').val(),\r\n\t\t\t\t\t\"propagate\" : $('#propagate').is(':checked') ? 1 : 0\r\n\t\t\t\t},\r\n\t\t\t\tsuccess:function(data){\r\n\t\t\t\t\tif(data.result == \"success\"){\r\n\t\t\t\t\t\t$('.action.metadata').removeClass('open');\r\n\t\t\t\t\t\t$('#propagate').prop('checked', false);\t\t\t\r\n\t\t\t\t\t\talertify.success(\"Printed page number saved successfully.\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\t\t \t\t\r\n\t\t\r\n\t}, \r\n\t\r\n\tloadPage : function(){\r\n\t\tvar n = location.hash.replace('#','');\r\n\t\tif(n == \"\") n=1;\r\n\t\t\t\t\r\n\t\tbid = $('body').attr('data-bid');\r\n\t\tissue = $('body').attr('data-issue');\r\n\t\t\r\n\t\tvar cat = ($('body').attr('data-type') == 'monograph') ? 'books' : 'journals';\r\n\t\tbid = ($('body').attr('data-type') == 'monograph') ? $('body').attr('data-provenance')+\"_\"+bid : bid;\r\n\t\t$('#pageview').html('');\r\n\t\tvar viewer = OpenSeadragon({\r\n\t    \tid: 'pageview',\r\n\t   \t \tprefixUrl: \"/i/openseadragon/\",\r\n\t    \ttileSources: $('#pageview').attr('data-baseuri')+\"::\"+n+\"/info.json\",\r\n\t    \tzoomPerScroll: 1.5,\r\n\t    \tshowNavigationControl: false,\r\n\t    \timmediateRender: true\r\n\t\t});\t\t\t\r\n\t\t\r\n\t\t$.ajax({\r\n\t        url: \"/document/page/text/\"+$('.thumb[data-n='+n+']').attr('data-oid'),\r\n\t        type: \"GET\",\r\n\t        dataType: \"html\",\r\n\t        success: function (data) {\r\n\t            $('#textview').html(data);\r\n\t            $('#ppn').val($('a.pn.b').attr('data-ppn'));\r\n\t            $('body').attr('data-pageid', $('.thumb[data-n='+n+']').attr('data-oid'));\r\n\t            LBC.refreshBookmarks();\r\n\t            LBC.refreshIndexgolden();\r\n\t        }\r\n\t    });\t\t\t\t\r\n\t\t\t\r\n\t\t$('.thumb').removeClass('active');\r\n\t\t$('.thumb[data-n='+n+']').addClass('active');\r\n\t\t$('.filmstrip').scrollTo($('.thumb.active'),200, {offset : {left: -$('.filmstrip').width()/2+100}});\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n};\r\n\r\nvar JOURNAL = {\r\n\r\n\tinit : function(){\r\n\t\t$(document).on('click', '.button', function(){\r\n\t\t\tdocument.location = '/document/overview/'+$('body').attr('data-bid')+'/'+$('select').val()\r\n\t\t});\r\n\t},\r\n\r\n};\r\n\r\nvar SEARCH = {\r\n\t\r\n\tpage : null,\r\n\t\r\n\tinit : function(){\r\n\t\t\r\n\t\tSEARCH.page = $('.noPage').text();\r\n\t\t\r\n\t\t$(document).on('click', '.chk', function(e){\r\n\t\t\tif($(this).hasClass('year'))\t$('.yearfilter').toggleClass('disabled');\r\n\t\t\t$(this).toggleClass('checked');\r\n\t\t\tSEARCH.page = 1;\r\n\t\t\tSEARCH.doSearch();\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.reset.allfilters', function(){\r\n\t\t\t$('#sidemenu .chk').removeClass('checked');\r\n\t\t\tSEARCH.page = 1;\r\n\t\t\tSEARCH.doSearch();\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.allfilters.unselect', function(){\r\n        \t$(this).closest('ul').find('li').removeClass('checked');\r\n\t\t\tSEARCH.page = 1;\r\n\t\t\tSEARCH.doSearch();\r\n        });\r\n        $(document).on('click', '.allfilters.select', function(){\r\n        \t$(this).closest('ul').find('li').addClass('checked');\r\n\t\t\tSEARCH.page = 1;\r\n\t\t\tSEARCH.doSearch(); \r\n        });\r\n\t\t\r\n        $(document).on('click', '.allfilters.viewmore', function(){\r\n        \t$(this).closest('ul').find('li:hidden:lt(7)').show();\r\n\t\t\tif($(this).closest('ul').find('li:hidden').length == 0)\r\n\t\t\t\t$(this).remove();\r\n        });\r\n\t\t\t\t\r\n\t\t\r\n\t\t$(document).on('click', '.sub', function(e){\r\n\t\t\tif(e.target != this) return;\r\n\t\t\t$(this).toggleClass('open');\r\n\t\t});\r\n\t\t\r\n\t\t\r\n\t\t$(document).on('click', '.countersbar li.docs', function () {\r\n\t\t\t$('.countersbar li.cat').removeClass('disabled');\r\n\t\t\tSEARCH.page = 1;\r\n\t\t\tSEARCH.doSearch();\r\n\t\t});\r\n\t\t\r\n\t\t\r\n\t\t$(document).on('click', '.countersbar li.cat', function () {\r\n\t\t\tif( $(this).hasClass('disabled') || $('.countersbar li.cat.disabled').length==0){\r\n\t\t\t\t$('.countersbar li.cat').addClass('disabled');\r\n\t\t\t\t$(this).removeClass('disabled');\r\n\t\t\t\tSEARCH.page = 1;\r\n\t\t\t\tSEARCH.doSearch();\r\n\t\t\t}else{\r\n\t\t\t\t$('.countersbar li.cat').removeClass('disabled');\r\n\t\t\t\tSEARCH.page = 1;\r\n\t\t\t\tSEARCH.doSearch();\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.card', function(e){\r\n\t\t\te.stopPropagation();\r\n\t\t\te.preventDefault();\r\n\t\t\tif($(this).hasClass('journal'))\r\n\t\t\t\tdocument.location = '/document/journal/'+$(this).attr('data-bid');\r\n\t\t\telse if($(this).hasClass('article'))\r\n\t\t\t\tdocument.location = '/article/overview/'+$(this).attr('data-oid');\r\n\t\t\telse if($(this).attr('data-bid') != \"\")\r\n\t\t\t\tdocument.location = '/document/overview/'+$(this).attr('data-bid');\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click','#content', function(){\r\n\t\t\t$('.countersbar li.cat').removeClass('disabled');\r\n\t\t\tSEARCH.page = 1;\r\n\t\t\tSEARCH.doSearch();\r\n\t\t});\t\t\r\n\t\t\r\n\t\t$(document).on('click', '.fa-arrow-circle-o-right', function(e){\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\r\n\t\t\tif($(this).closest('.card').attr('data-bid') != \"\")\r\n\t\t\t\tdocument.location = '/document/overview/'+$(this).closest('.card').attr('data-bid')+'/'+$(this).closest('.card').find('select').val();\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.card.journal select', function(e){\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\r\n        $(document).on('keyup','#search input', function(e){\r\n            var code = e.keyCode || e.which;\r\n             if(code == 13) { //Enter keycode\r\n             \tSEARCH.doSearch();\r\n             }\r\n        });\r\n\t\t\r\n\t\t$(document).on('click', '.fa-angle-left', function(){\r\n\t\t\tSEARCH.page--;\t\t\r\n\t\t\tSEARCH.doSearch();\t\r\n\t\t});\t\t\r\n\r\n\t\t$(document).on('click', '.fa-angle-right', function(){\r\n\t\t\tSEARCH.page++;\t\t\r\n\t\t\tSEARCH.doSearch();\t\r\n\t\t});\t\t\r\n\r\n\t\t$(document).on('change', 'select#sort', function(){\r\n\t\t\tSEARCH.page = 1;\t\t\r\n\t\t\tSEARCH.doSearch();\t\r\n\t\t});\t\t\r\n\r\n\t\t \r\n\t\tSEARCH.doSearch();\r\n\t},\r\n\t\r\n\tgetFilters : function(){\r\n\t\tvar filtrs = {};\t\r\n\t\t$('.sub').each(function(){\r\n\t\t\tvar sub = $(this);\r\n\t\t\tfiltrs[sub.attr('data-field')] = [];\r\n\t\t\t\r\n\t\t\t$(this).find('li.checked').each(function(){\r\n\t\t\t\tfiltrs[sub.attr('data-field')].push($(this).attr('data-key'));\r\n\t\t\t});\r\n\t\t});\t\r\n\t\t\r\n\t\tvar mindate = $('input[name=\"mindate\"]').val();\r\n        var maxdate = $('input[name=\"maxdate\"]').val();\r\n        if($('.chk.year').hasClass('checked') && (mindate != \"\" || maxdate != \"\")){\r\n            filtrs.year = {};\r\n            filtrs.year.mindate = mindate;\r\n            filtrs.year.maxdate = maxdate;\r\n        }\r\n        \r\n        \r\n\t\treturn filtrs;\r\n\t},\r\n\t\r\n\trefreshFilters : function(){\r\n\r\n\r\n\t\t\r\n\t\tvar filtrs = SEARCH.getFilters();\r\n\r\n\t\t$('.sub').each(function(){\r\n\t\t\tvar sub = $(this);\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/filters\",\r\n\t\t        type: \"POST\",\r\n\t\t        data: {\r\n\t\t        \t'q': $('#search input').val(),\r\n\t\t        \t'ns': $.map($('.countersbar li.cat:not(.disabled)'), function(a) { return $(a).attr(\"data-ns\");}),\r\n\t\t        \t'in' : {\r\n\t\t        \t\t'authors' : $('.filters .chk.authors').hasClass('checked'),\r\n\t\t        \t\t'titles' : $('.filters .chk.titles').hasClass('checked'), \r\n\t\t        \t\t'publishers' : $('.filters .chk.publishers').hasClass('checked'),\t\r\n\t\t        \t},\r\n\t\t        \t'field' : sub.attr('data-field'),\r\n\t\t        \t'filtrs' : filtrs,\r\n\t\t        \t\t\t\r\n\t\r\n\t\t        },\r\n\t\t        dataType: \"html\",\r\n\t\t        success: function (data) {\r\n\t\t        \tsub.find('ul').html(data);\r\n\t\t\t\t}\r\n\t\t\t});\t\t\r\n\t\t});\r\n\t},\r\n\t\r\n\tcounterNotation : function(n){\r\n\t\t\r\n\t\tif(n > 9999){\r\n\t\t\treturn (Math.floor(n/1000))+\"k\";\r\n\t\t}else{\r\n\t\t\treturn n;\r\n\t\t}\r\n\t\t\r\n\t},\r\n\t\r\n\tdoSearch : function(){\r\n\t\t\r\n\t\tSEARCH.refreshFilters();\r\n\t\tSEARCH.yearBarChart();\r\n\t\t\r\n\t\tvar filtrs = SEARCH.getFilters();\r\n\r\n\t\t$.ajax({\r\n\t        url: \"/count\",\r\n\t        type: \"POST\",\r\n\t        data: {\r\n\t        \t'q': $('#search input').val(),\r\n\t        \t'page' : SEARCH.page,\r\n\t        \t'in' : {\r\n\t        \t\t'authors' : $('.filters .chk.authors').hasClass('checked'),\r\n\t        \t\t'titles' : $('.filters .chk.titles').hasClass('checked'), \r\n\t        \t\t'publishers' : $('.filters .chk.publishers').hasClass('checked'),\t\r\n\t        \t},\r\n\t        \t'filtrs' : filtrs, \r\n\t        \t'sort' : $('select#sort').val()\r\n\t        },\r\n\t        dataType: \"json\",\r\n\t        success: function (data) {\r\n\t        \t$('.docs span').html(SEARCH.counterNotation(data.response.response.numFound));\t\r\n\t        \t$('.cat.monograph span').html(SEARCH.counterNotation(data.response.facet_counts.facet_fields.ns[_SOLR_ROOT_+'.bibliodb_books']));\r\n\t        \t$('.cat.article span').html(SEARCH.counterNotation(data.response.facet_counts.facet_fields.ns[_SOLR_ROOT_+'.bibliodb_articles']));\r\n\t        \t$('.cat.journal span').html(SEARCH.counterNotation(data.response.facet_counts.facet_fields.ns[_SOLR_ROOT_+'.bibliodb_journals']));\r\n\t\t\t\t$('.cat.contribution span').html(0);\r\n\t        }\r\n\t    });\t\r\n\r\n\t\t\r\n\t\t$.ajax({\r\n\t        url: \"/search\",\r\n\t        type: \"POST\",\r\n\t        data: {\r\n\t        \t'q': $('#search input').val(),\r\n\t        \t'ns': $.map($('.countersbar li.cat:not(.disabled)'), function(a) { return $(a).attr(\"data-ns\");}),\r\n\t        \t'page' : SEARCH.page,\r\n\t        \t'in' : {\r\n\t        \t\t'authors' : $('.filters .chk.authors').hasClass('checked'),\r\n\t        \t\t'titles' : $('.filters .chk.titles').hasClass('checked'), \r\n\t        \t\t'publishers' : $('.filters .chk.publishers').hasClass('checked'),\t\r\n\t        \t},\r\n\t        \t'filtrs' : filtrs,\r\n\t        \t'sort' : $('select#sort').val()\r\n\t        },\r\n\t        dataType: \"json\",\r\n\t        success: function (data) {\r\n\t        \tnbPages = Math.ceil(data.response.response.numFound / 12);\r\n\t        \t$('.docs span').html(data.response.response.numFound);\r\n\t        \t$('span.noPage').html(SEARCH.page);\r\n\t        \t$('span.nbPage').html(nbPages);\r\n\t        \tif(SEARCH.page == 1)\r\n\t        \t\t$('.fa-angle-left').hide();\r\n\t        \telse\r\n\t        \t\t$('.fa-angle-left').show();\r\n\t        \t\r\n\t        \tif(SEARCH.page == nbPages)\r\n\t        \t\t$('.fa-angle-right').hide();\r\n\t        \telse\r\n\t        \t\t$('.fa-angle-right').show();\r\n\t        \t\r\n\t\t\t\t$('div.results').html('');\r\n\t\t\t\tfor(var res in data.results){\r\n\t\t\t\t\tSEARCH.result.object = data.results[res];\r\n\t\t\t\t\t\r\n\t\t\t\t\tdiv = $('<div class=\"card '+SEARCH.result.getClass()+'\" data-oid=\"'+SEARCH.result.getOID()+'\" data-bid=\"'+SEARCH.result.getBid()+'\"></div>');\r\n\t\t\t\t\tdiv.append('<p>'+SEARCH.result.getType()+'</p>');\r\n\t\t\t\t\tdiv.append('<p>'+SEARCH.result.getTitle()+'</p>');\r\n\t\t\t\t\tdiv.append('<p>'+SEARCH.result.getAuthor()+'</p>');\r\n\t\t\t\t\tdiv.append('<p>'+SEARCH.result.getDate()+'</p>');\r\n\t\t\t\t\tdiv.append('<p>'+SEARCH.result.getVolume()+'</p>');\r\n\t\t\t\t\tdiv.append('<p>'+SEARCH.result.getTitleOfJournal()+'</p>');\r\n\t\t\t\t\t$('div.results').append(div);\t\r\n\t\t\t\t}\r\n\t        }\r\n\t    });\t\r\n\r\n\t},\r\n\t\r\n    yearBarChart : function() {\r\n    \t\r\n    \tvar filtrs = SEARCH.getFilters();\r\n    \t\r\n    \t\r\n        $.ajax({\r\n            url: \"/yearChart\",\r\n            type: \"POST\",\r\n            data: {\r\n\t        \t'q': $('#search input').val(),\r\n\t        \t'ns': $.map($('.countersbar li.cat:not(.disabled)'), function(a) { return $(a).attr(\"data-ns\");}),\r\n\t        \t'page' : SEARCH.page,\r\n\t        \t'in' : {\r\n\t        \t\t'authors' : $('.filters .chk.authors').hasClass('checked'),\r\n\t        \t\t'titles' : $('.filters .chk.titles').hasClass('checked'), \r\n\t        \t\t'publishers' : $('.filters .chk.publishers').hasClass('checked'),\t\r\n\t        \t},\r\n\t        \t'filtrs' : filtrs   \r\n            },\r\n            dataType: \"json\",\r\n            success: function (data) {\r\n                $('.barchart').html('');\r\n                var range = $('.yearslider')[0];\r\n                try{\r\n                    range.noUiSlider.destroy();\r\n                }catch(e){}\r\n                if(data.length == 0) return;\r\n                var range = $('.yearslider')[0];\r\n                var dataArray = data.val;\r\n                var barwidth = 160/dataArray.length;\r\n                var max = Math.max.apply(null, dataArray);\r\n                var svg = d3.select(\".barchart\").append(\"svg\")\r\n                          .attr(\"height\",\"75px\")\r\n                          .attr(\"width\",\"160px\");\r\n                svg.selectAll(\"rect\")\r\n                    .data(dataArray)\r\n                    .enter().append(\"rect\")\r\n                          .attr(\"class\", \"baryear\")\r\n                          .attr(\"height\", function(d, i) {return (d/max*75)})\r\n                          .attr(\"width\",barwidth)\r\n                          .attr(\"x\", function(d, i) {return (i * barwidth)})\r\n                          .attr(\"y\", function(d, i) {return 75 - (d/max*75)});\r\n                noUiSlider.create(range, {\r\n                    start: [data.selectedMin,data.selectedMax],\r\n                    connect: true, // Display a colored bar between the handles\r\n                    direction: 'ltr', // Put '0' at the bottom of the slider\r\n                    behaviour: 'tap-drag', // Move handle on tap, bar is draggable\r\n                    step: 1,\r\n                    tooltips: true,\r\n                    range: {\r\n                        'min': data.minYear-(data.maxYear-data.minYear)/4,\r\n                        'max': data.maxYear+(data.maxYear-data.minYear)/4\r\n                    },\r\n                        pips: {\r\n                        mode: 'values',\r\n                        values: [data.minYear,data.maxYear],\r\n                        density: 5\r\n                    },\r\n                      format: {\r\n                          to: function ( value ) {\r\n                            return parseInt(value,10);\r\n                          },\r\n                          from: function (value) { return value; }\r\n                        }\r\n                });\r\n                range.noUiSlider.on('change', function ( values, handle ) {\r\n                    if ( values[handle] < data.minYear ) {\r\n                        range.noUiSlider.set([data.minYear,null]);\r\n                    } else if ( values[handle] > data.maxYear ) {\r\n                        range.noUiSlider.set([null,data.maxYear]);\r\n                    }\r\n                });\r\n                range.noUiSlider.on('set', function ( values) {\r\n                    $('input[name=\"mindate\"]').val(values[0]);\r\n                    $('input[name=\"maxdate\"]').val(values[1]);\r\n\t\t\t\t\tSEARCH.page = 1;\r\n\t\t\t\t\tSEARCH.doSearch();\r\n                });\r\n            }\r\n        });\r\n    },\r\n\t\r\n\tresult : { \r\n\t\tobject : null,\r\n\t\t\r\n\t\tgetOID : function(){\r\n\t\t\treturn this.object['_id'];\r\n\t\t},\r\n\t\t\r\n\t\tgetBid : function(){\r\n\t\t\treturn this.object['bid'] || '';\t\r\n\t\t},\r\n\t\t\r\n\t\tgetClass : function(){\r\n\t\t\treturn this.object['_type_'];\r\n\t\t},\r\n\t\t\r\n\t\tgetType : function(){\r\n\t\t\tswitch(this.object['_type_']){\r\n\t\t\t\tcase 'monograph': return 'Book';  break;\r\n\t\t\t\tcase 'article': return 'Article';  break;\r\n\t\t\t\tcase 'journal': return 'Journal '+SEARCH.result.getIssues();  break;\r\n\t\t\t}\r\n\t\t\treturn '';\r\n\t\t},\r\n\t\t\r\n\t\tgetIssues : function(){\r\n\t\t\tvar options = \"<option>search issue</option>\";\r\n\t\t\tvar n = 0;\r\n\t\t\tfor(var issue in SEARCH.result.object._meta_.issues){\t\t\t\r\n\t\t\t\tvar is = SEARCH.result.object._meta_.issues[issue];\r\n\t\t\t\tif(is.marked_as_removed == false){\r\n\t\t\t\t\toptions += \"<option value='\"+is.foldername+\"'>\"+is.foldername+\"</option>\";\r\n\t\t\t\t\tn++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn '<span>'+n+' Issues <select>'+options+'</select> <i class=\"fa fa-arrow-circle-o-right\"></i></span>';\r\n\t\t},\r\n\t\t\r\n\t\tgetTitle : function(){\r\n\t\t\tswitch(this.object['_type_']){\r\n\t\t\t\tcase 'monograph': return this.object.title || '';  break;\r\n\t\t\t\tcase 'article': return this.object.title || '';  break;\r\n\t\t\t\tcase 'journal': return this.object.full_title || '';  break;\r\n\t\t\t}\r\n\t\t},\r\n\t\t\r\n\t\tgetAuthor : function(){\r\n\t\t\tswitch(this.object['_type_']){\r\n\t\t\t\tcase 'monograph': return this.object.author || '';  break;\r\n\t\t\t\tcase 'article': return this.object.authors[0] || '';  break;\r\n\t\t\t}\r\n\t\t\treturn '';\r\n\t\t},\r\n\t\tgetVolume : function(){\r\n\t\t\tswitch(this.object['_type_']){\r\n\t\t\t\tcase 'article': return 'Volume : '+this.object.volume || '';  break;\r\n\t\t\t}\r\n\t\t\treturn '';\t\r\n\t\t},\r\n\t\tgetDate : function(){\r\n\t\t\tswitch(this.object['_type_']){\r\n\t\t\t\tcase 'monograph': return this.object.publication_year || '' ;  break;\r\n\t\t\t\tcase 'journal': \r\n\t\t\t\t\tvar min = 9999;\r\n\t\t\t\t\tvar max = 0;\r\n\t\t\t\t\tfor(var issue in SEARCH.result.object._meta_.issues){\t\t\t\r\n\t\t\t\t\t\tvar is = SEARCH.result.object._meta_.issues[issue];\r\n\t\t\t\t\t\tif(is.year < min) min = is.year;\r\n\t\t\t\t\t\tif(is.year > max) max = is.year;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn 'From '+min+' to '+max;  \r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'article': return this.object.year || ''; break;\r\n\t\t\t}\r\n\t\t\treturn '';\r\n\t\t},\r\n\t\tgetTitleOfJournal : function(){\r\n\t\t\tswitch(this.object['_type_']){\r\n\t\t\t\tcase 'article': return this.object._journal_.short_title || '';  break;\r\n\t\t\t}\r\n\t\t\treturn '';\r\n\t\t},\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n};\r\n\r\nvar REF = {\r\n\tallRefs : [],\r\n\t\r\n\thighlight : function(){\r\n\t\t\r\n\t\tvar q = $('#textSearch input').val();\r\n\t\t\r\n\t\t\t\t\r\n\t\t$('.fulltext').unmark({\r\n      \t\tdone: function() {\r\n\t        \t$('.fulltext').mark(q, {\r\n\t          \t\tseparateWordSearch: true,\r\n\t          \t\taccuracy:'complementary'\r\n\t        \t});\r\n      \t\t}\r\n    \t});\r\n\t\r\n\t\t\r\n\t},\r\n\t\r\n\tloadPage : function(div){\r\n\t\t\r\n\t\t$.ajax({\r\n\t\t    \tbeforeSend : function(){\r\n\t\t    \t\tdiv.removeClass('notLoaded');\r\n\t\t    \t},\r\n\t\t        url: \"/document/page/text/\"+div.attr('data-oid'),\r\n\t\t        type: \"GET\",\r\n\t\t        dataType: \"html\",\r\n\t\t        success: function (data) {\r\n\t\t            div.html(data);\r\n\t\t\t\t\tREF.highlight();\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t        url: \"/document/page/references/\"+div.attr('data-oid'),\r\n\t\t\t\t        type: \"GET\",\r\n\t\t\t\t        dataType: \"json\",\r\n\t\t\t\t        success: function (data) {\r\n\t\t\t\t\t\t\tfor(var ref in data){\r\n\t\t\t\t            \tvar token = data[ref]['contents'][1];\r\n\t\t\t\t\t\t\t\tdiv.find('span[_st='+token['start']+']').after('<em data-ref=\"'+ref+'\" class=\"'+data[ref]['dis']+' '+data[ref]['ref_type']+'\"></em>');\r\n\t\t\t\t\t\t\t\tREF.allRefs[ref] = data[ref];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tvar heights = [];\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t$(div.find('em').get().reverse()).each(function() { \r\n\t\t\t\t\t\t\t\tif(heights[$(this).position().top] == undefined){\r\n\t\t\t\t\t\t\t\t\theights[$(this).position().top] = 0;\r\n\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\theights[$(this).position().top] += 1;\r\n\t\t\t\t\t\t\t\t\t$(this).addClass('x'+heights[$(this).position().top]);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t        }\r\n\t\t\t\t    });\t\r\n\t\t\t\t\t\t            \r\n\t\t            \r\n\t\t        }\r\n\t\t    });\t\r\n\t\t\r\n\t},\r\n\t\r\n\tinit : function(){\r\n\t\t$(document).on('mouseenter','div.notLoaded' ,function(){\r\n\t\t\tvar div = $(this);\r\n\t\t\tREF.loadPage(div);\r\n\t\t});\r\n\t\t\r\n\t\t$(\"#showallrefs\").change(function() {\r\n\t\t    if(this.checked) {\r\n\t\t        $('.fulltext').removeClass('displayonlydisamb');\r\n\t\t        $('.fulltext').addClass('displayallrefs');\r\n\t\t    }else{\r\n\t\t        $('.fulltext').addClass('displayonlydisamb');\r\n\t\t        $('.fulltext').removeClass('displayallrefs');\t\r\n\t\t    }\r\n\t\t});\r\n\t\t\r\n\t\t$('div.notLoaded:lt(5)').each(function(){\r\n\t\t\tdiv = $(this);\r\n\t\t\tREF.loadPage(div);\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', 'a.pn', function(){\r\n\t\t\tdocument.location.href = document.location.href.replace('references','viewer')+\"#\"+$(this).text(); \r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', 'em', function(){\r\n\t\t\t$('em').removeClass('active');\r\n\t\t\t$('span').removeClass('hl');\r\n\t\t\t$(this).addClass('active');\r\n\t\t\tvar div = $(this).closest('div.page');\r\n\t\t\tvar ref = $(this).attr('data-ref');\r\n\t\t\t$('.refDetails').html('');\r\n\t\t\t$('.refDetails').removeClass('editmode');\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/page/reference/\"+ref,\r\n\t\t        type: \"GET\",\r\n\t\t        dataType: \"html\",\r\n\t\t        success: function (data) {\r\n\t\t            $('.refDetails').html(data);\r\n\t\t            $('.refDetails').removeClass('editmode');\r\n\t\t            $('.refDetails .ui.dropdown.typeselect').dropdown();\r\n\t\t        }\r\n\t\t    });\t\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar contents = REF.allRefs[ref]['contents'];\r\n\t\t \tfor(var content in contents){\r\n\t\t\t\tvar token = contents[content];\r\n\t\t\t\tdiv.find('span').filter(function(){\r\n\t\t\t\t\treturn $(this).attr('_st') >= token['start'] && $(this).attr('_en') <= token['end'];\r\n\t\t\t\t}).addClass('hl');\r\n\t        }\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t});\t\t\r\n\t\t\r\n\t\t$(document).on('click', '.action.edit', function(){\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\tvar rD = $(this).closest('.refDetails');\r\n\t\t\trD.toggleClass('editmode');\r\n\t\t\t\r\n\t\t\trD.find('tr.type').css('color', 'black');\r\n\t\t\trD.find('tr.type span.val').hide();\r\n\t\t\trD.find('tr.type .ui.dropdown').show();\r\n\t\t\trD.find('tr.type .action.validate').show();\r\n\t\t});\r\n\r\n\r\n\t\t\r\n\t\t$(document).on('click', '.action.valid', function(){\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar ref = $(this).closest('table').attr('data-ref');\r\n\t\t\t\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/saveReferenceDisambiguationValid\",\r\n\t\t        type: \"POST\",\r\n\t\t        dataType: \"json\",\r\n\t\t        data : {\r\n\t\t        \treference: ref,\r\n\t\t        },\r\n\t\t        beforeSend : function(){\r\n\t\t        \t$('.refDetails').html('');\r\n\t\t        },\r\n\t\t        success: function (data) {\r\n\t\t\t\t\t$('em.active').click();\r\n\t\t        }\r\n\t\t    });\t\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\r\n\r\n\r\n\t\t$(document).on('click', '.action.cancel', function(){\r\n\t\t\t$('em.active').click();\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', 'tr.type .validate', function(){\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\ttr = $(this).closest('tr');\r\n\t\t\trD = tr.closest('.refDetails');\r\n\t\t\told = tr.find('span.val').text();\r\n\t\t\ttr.find('span.val').text(tr.find('.ui.dropdown').dropdown('get text'));\r\n\t\t\tchangetype = (old != tr.find('.ui.dropdown').dropdown('get text'));\r\n\t\t\t\t\r\n\t\t\tif(tr.find('.ui.dropdown').dropdown('get value') == 'primary') source = 'asve';\r\n\t\t\tif(tr.find('.ui.dropdown').dropdown('get value') == 'secondary') source = 'book';\r\n\t\t\ttr.find('span.val').show();\r\n\t\t\ttr.find('.dropdown').hide();\r\n\t\t\tif(changetype){\r\n\t\t\t\trD.find('tr.data').hide();\r\n\t\t\t}\r\n\t\t\t$(this).hide();\r\n\t\t\trD.find('tr.title').show();\r\n\t\t\trD.find('tr.title').css('color', 'black');\r\n\t\t\trD.find('tr.title span.val').hide();\r\n\t\t\trD.find('tr.title .ui.dropdown.'+source).show();\r\n\t\t\trD.find('tr.title .ui.dropdown.'+source).dropdown({\r\n\t\t\t\tapiSettings: {\r\n\t\t\t\t\turl: '/search/reftitle/'+source+'/{query}?rand='+Math.random(),\r\n\t\t\t\t\tthrottle: 200\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\trD.find('tr.title .action.validate').show();\r\n\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', 'tr.title .validate', function(){\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar ref = $(this).closest('table').attr('data-ref');\r\n\t\t\tvar type = $('.ui.dropdown.typeselect').dropdown('get value');\r\n\t\t\tvar title = (type == 'primary') ? $('.ui.dropdown.title.asve').dropdown('get value') :  $('.ui.dropdown.title.book').dropdown('get value');\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/saveReferenceDisambiguation\",\r\n\t\t        type: \"POST\",\r\n\t\t        dataType: \"json\",\r\n\t\t        data : {\r\n\t\t        \treference: ref,\r\n\t\t        \ttype: type,\r\n\t\t        \ttitle: title\r\n\t\t        },\r\n\t\t        beforeSend : function(){\r\n\t\t        \t$('.refDetails').html('');\r\n\t\t        },\r\n\t\t        success: function (data) {\r\n\t\t\t\t\t$('em.active').click();\r\n\t\t        }\r\n\t\t    });\t\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\t\t\t\r\n\t\t$(document).on('click', '.fa.disamb', function(){\r\n\t\t\t\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif($(this).hasClass('fa-spinner'))\r\n\t\t\t\treturn;\r\n\t\t\t\t\r\n\t\t\tvar from = ($(this).hasClass('fa-check')) ? 'fa-check' : 'fa-times';\r\n\t\t\tvar to = ($(this).hasClass('fa-check')) ? 'fa-times' : 'fa-check';\r\n\t\t\tvar value = (to == 'fa-check') ? true : false; \r\n\t\t\tvar dis = $(this).closest('table').attr('data-dis');\r\n\t\t\tvar field = $(this).attr('data-field');\r\n\t\t\tvar button = $(this);\r\n\t\t\t\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/saveReferenceDisambiguationState\",\r\n\t\t        type: \"POST\",\r\n\t\t        dataType: \"json\",\r\n\t\t        data : {\r\n\t\t        \tdis: dis,\r\n\t\t        \tfield: field,\r\n\t\t        \tvalue: value\r\n\t\t        },\r\n\t\t        beforeSend : function(){\r\n\t\t        \tbutton.removeClass(from);\r\n\t\t        \tbutton.addClass('fa-spinner fa-pulse');\r\n\t\t        },\r\n\t\t        success: function (data) {\r\n\t\t        \tbutton.removeClass('fa-spinner fa-pulse');\r\n\t\t        \tbutton.addClass(to);\r\n\t\t        \talertify.success(\"Flag change successfully\");\t\r\n\t\t        }\r\n\t\t    });\t\t\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\r\n\t\t$(document).on('click', '.fa.refer', function(){\r\n\t\t\t\r\n\t\t\tif(! LBC.checkCred()) return;\r\n\t\t\t\r\n\t\t\tif($(this).hasClass('fa-spinner'))\r\n\t\t\t\treturn;\r\n\t\t\t\t\r\n\t\t\tvar from = ($(this).hasClass('fa-check')) ? 'fa-check' : 'fa-times';\r\n\t\t\tvar to = ($(this).hasClass('fa-check')) ? 'fa-times' : 'fa-check';\r\n\t\t\tvar value = (to == 'fa-check') ? true : false; \r\n\t\t\tvar ref = $(this).closest('table').attr('data-ref');\r\n\t\t\tvar field = $(this).attr('data-field');\r\n\t\t\tvar button = $(this);\r\n\t\t\t\r\n\t\t\t$.ajax({\r\n\t\t        url: \"/document/saveReferenceState\",\r\n\t\t        type: \"POST\",\r\n\t\t        dataType: \"json\",\r\n\t\t        data : {\r\n\t\t        \tref: ref,\r\n\t\t        \tfield: field,\r\n\t\t        \tvalue: value\r\n\t\t        },\r\n\t\t        beforeSend : function(){\r\n\t\t        \tbutton.removeClass(from);\r\n\t\t        \tbutton.addClass('fa-spinner fa-pulse');\r\n\t\t        },\r\n\t\t        success: function (data) {\r\n\t\t        \tbutton.removeClass('fa-spinner fa-pulse');\r\n\t\t        \tbutton.addClass(to);\r\n\t\t        \tif(field == 'correct'){\r\n\t\t        \t\t$('.fa.refer[data-field=\"checked\"]').removeClass(\"fa-times\").addClass(\"fa-check\");\r\n\t\t        \t}\r\n\t\t        \talertify.success(\"Flag change successfully\");\t\r\n\t\t        }\r\n\t\t    });\t\t\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\t\t\t\t\r\n\t\t\r\n\t\t$(document).on('keyup', '#textSearch input', function(){\r\n\t\t\tvar input = $(this);\r\n\t\t\tif(input.val().length >= 3){\r\n\t\t\t\t$.ajax({\r\n\t\t\t        url: \"/document/page/references/textsearch\",\r\n\t\t\t        type: \"POST\",\r\n\t\t\t        dataType: \"json\",\r\n\t\t\t        data : {\r\n\t\t\t        \tdocument_id : $('body').attr('data-documentid'),\r\n\t\t\t        \tsearch : input.val()\r\n\t\t\t        },\r\n\t\t\t        success: function (data) {\r\n\t\t\t        \t$('.separator').remove();\r\n\t\t\t        \t$('.page').hide();\r\n\t\t\t        \tif(data.length > 0){\r\n\t\t\t\t        \tfor(var n in data){\r\n\t\t\t\t        \t\t$('.page[data-n=\"'+data[n]+'\"]').show();\r\n\t\t\t\t        \t}\r\n\t\t\t\t        \r\n\t\t\t\t\t        visiblePages = $('.page:visible');\r\n\t\t\t\t        \tfor(var z = 0; z < visiblePages.length - 1; z++){\r\n\t\t\t\t        \t\tvar me = $(visiblePages[z]);\r\n\t\t\t\t        \t\tvar next = me.next('.page:visible');\r\n\t\t\t\t        \t\tc = parseInt(me.attr('data-n'),10);\r\n\t\t\t\t        \t\tn = parseInt(next.attr('data-n'),10);\r\n\t\t\t\t        \t\tif(n != c + 1){\r\n\t\t\t\t        \t\t\tme.after('<div class=\"separator\">•••</div>');\t\r\n\t\t\t\t        \t\t}\r\n\t\t\t\t        \t}\r\n\t\t\t\t        \t\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t$('.page').show();\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t        \tREF.highlight();\r\n\t\t\t        }\r\n\t\t\t       \r\n\t\t\t    });\t\r\n\t\t  }else{\r\n\t\t  \tREF.highlight();\r\n\t\t  \t$('.separator').remove();\r\n\t\t  \t$('.page').show();\r\n\t\t  }\r\n\t\t\t\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\t}\r\n\t\r\n};\r\n\r\nvar TOC = {\r\n\tpage : null,\r\n\ttrAddNew : null,\r\n\tinit : function() {\r\n\t\t\r\n\t\tTOC.goPage(1);\r\n\t\t\r\n\t\t$(document).on('click','a.prev',TOC.prev);\r\n\t\t$(document).on('click','a.next',TOC.next);\r\n\t\t\r\n\t\t$('#goPage').change(function(){\r\n\t\t\tn = parseInt($(this).val());\r\n\t\t\tif(n !== TOC.page){\r\n\t\t\t\tTOC.goPage(n);\t\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.fa-pencil-square-o', function(){\r\n\t\t\t$(this).toggleClass('fa-pencil-square-o fa-save');\r\n\t\t\t$(this).closest('tr').toggleClass('editOff editOn');\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.fa-plus-square-o', function(){\r\n\t\t\ttrAddNew = $('tr[data-id=\"new\"]').clone();\r\n\t\r\n\t\t\t$(this).toggleClass('fa-plus-square-o fa-save');\r\n\t\t\t$(this).closest('tr').toggleClass('editOff editOn');\r\n\t\t});\r\n\t\t\r\n\t\t$(document).on('click', '.fa-save', function(){\r\n\t\t\ttr = $(this).closest('tr');\r\n\t\t\r\n\t\t\tvar datas = {\r\n\t\t\t\t\t\"document_id\": $('body').attr('data-documentid'),\r\n\t\t\t\t\t\"article_id\": tr.attr('data-id'),\r\n\t\t\t\t\t\"authors\" : tr.find('.dropdown.author').dropdown('get value'),\r\n\t\t\t\t\t\"title\" : tr.find('input.title').val(),\r\n\t\t\t\t\t\"page_start\" : tr.find('.dropdown.page.start').dropdown('get value'),\r\n\t\t\t\t\t\"page_end\" : tr.find('.dropdown.page.end').dropdown('get value')\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tif(datas.title == \"\"){\r\n\t\t\t\talertify.error(\"Title is required.\");\t\t\t\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(datas.page_start == \"\"){\r\n\t\t\t\talertify.error(\"Page start is required.\");\t\t\t\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(datas.page_end == \"\"){\r\n\t\t\t\talertify.error(\"Page end is required.\");\t\t\t\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(parseInt(datas.page_end,10) < parseInt(datas.page_start,10)){\r\n\t\t\t\talertify.error(\"Page end should be greather than page start.\");\t\t\t\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: \"/document/saveArticle\",\r\n\t\t\t\ttype:'POST',\r\n\t\t\t\tdataType:'JSON',\r\n\t\t\t\tdata: datas,\r\n\t\t\t\tsuccess:function(data){\r\n\t\t\t\t\tif(data.result == \"success\"){\r\n\t\t\t\t\t\talertify.success(\"Article updated successfully.\");\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif(datas['article_id'] == 'new'){\r\n\t\t\t\t\t\t\t$('tr[data-id=\"new\"]').attr('data-id', data.article_id);\t\t\t\t\t\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar tr = $('tr[data-id=\"'+data.article_id+'\"]');\r\n\t\t\t\t\t\ttr.find('td.author .textual').text(data.authors);\r\n\t\t\t\t\t\ttr.find('td.title .textual').text(data.title);\r\n\t\t\t\t\t\ttr.find('td.pagerange .textual').text(data.pagerange);\r\n\t\t\t\t\t\ttr.find('td.actions .fa-save').toggleClass('fa-pencil-square-o fa-save');\r\n\t\t\t\t\t\ttr.toggleClass('editOn editOff');\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\ttr.closest('table').append(trAddNew);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t$('tr[data-id=\"new\"] .ui.dropdown.author').dropdown({\r\n\t\t\t\t\t\t\tapiSettings: {\r\n\t\t\t\t\t\t\t\turl: '/search/authors/{query}?rand='+Math.random(),\r\n\t\t\t\t\t\t\t\tthrottle: 200\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tdelimiter: '|#|'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t$('tr[data-id=\"new\"] .ui.dropdown.page').dropdown();\t\r\n\t\t\r\n\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t\t\t\r\n\r\n\t\t});\r\n\t\t\t\t\r\n\t\t\r\n\t\t\r\n\t\t$('.ui.dropdown.author').dropdown({\r\n\t\t\tapiSettings: {\r\n\t\t\t\turl: '/search/authors/{query}?rand='+Math.random(),\r\n\t\t\t\tthrottle: 200\r\n\t\t\t},\r\n\t\t\tdelimiter: '|#|'\r\n\t\t});\r\n\t\t$('.ui.dropdown.page').dropdown();\t\t\r\n\t},\r\n\t\r\n\tprev : function() {TOC.goPage(TOC.page-2);},\r\n\tnext : function() {TOC.goPage(TOC.page+2);},\r\n\tgoPage : function(n) {\r\n\t\tif(n % 2 == 0) n--;\r\n\r\n\t\tnbPage = parseInt($('body').attr('data-pagecount'),10);\r\n\t\tbid = $('body').attr('data-bid');\r\n\t\tissue = $('body').attr('data-issue');\r\n\r\n\t\tif(n < 1 || n > nbPage)\r\n\t\t\treturn;\r\n\t\t\r\n\t\tTOC.page = n;\r\n\t\t$('#goPage').val(TOC.page);\r\n\r\n\t\tleft = n;\r\n\t\tright = n+1;\t\r\n\t\tif(right > nbPage) right = null;\r\n\t\t\t\r\n\t\t$('#openseadragon_left').html('');\r\n\t\t$('#openseadragon_right').html('');\t\r\n\t\t\t\r\n\t\tif(left !== null){\r\n\t\t\tvar viewerL = OpenSeadragon({\r\n\t        \tid: 'openseadragon_left',\r\n\t       \t \tprefixUrl: \"/i/openseadragon/\",\r\n\t        \ttileSources: _IIIF_ROOT_+bid+\"::\"+issue+\"::\"+left+\"/info.json\",\r\n\t        \tzoomPerScroll: 1.5,\r\n\t        \tshowNavigationControl: false,\r\n\t        \timmediateRender: true\r\n\t    \t});\t\t\t\r\n\t    \t$('.leftPg').html(left);\r\n\t\t}\r\n\t\tif(right !== null){\r\n\t\t\tvar viewerR = OpenSeadragon({\r\n\t        \tid: 'openseadragon_right',\r\n\t       \t \tprefixUrl: \"/i/openseadragon/\",\r\n\t        \ttileSources: _IIIF_ROOT_+bid+\"::\"+issue+\"::\"+right+\"/info.json\",\r\n\t        \tzoomPerScroll: 1.5,\r\n\t        \tshowNavigationControl: false,\r\n\t        \timmediateRender: true\r\n\t    \t});\t\t\r\n\t    \t$('.rightPg').html(right);\t\r\n\t\t}\r\n\t\t\r\n\t\tif(left == 1){\r\n\t\t\t$('a.prev').hide();\t\r\n\t\t}else{\r\n\t\t\t$('a.prev').show();\t\t\r\n\t\t}\r\n\r\n\t\tif(right == nbPage || left == nbPage){\r\n\t\t\t$('a.next').hide();\t\r\n\t\t}else{\r\n\t\t\t$('a.next').show();\t\t\r\n\t\t}\r\n\t\t\r\n\t\t\t\r\n\t}\r\n\t\r\n\t\r\n};\r\n\r\n\r\n\r\n$(document).ready(LBC.init);\r\n"]}